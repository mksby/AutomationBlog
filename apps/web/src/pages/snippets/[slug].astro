---
import BaseLayout from "@/layouts/BaseLayout.astro";
import TagList from "@/components/TagList.astro";
import AuthorCard from "@/components/AuthorCard.astro";
import { getCodeSnippets, getCodeSnippetBySlug } from "@/lib/strapi";

export async function getStaticPaths() {
  const { data: snippets } = await getCodeSnippets(1, 100);
  return snippets.map((s: any) => ({ params: { slug: s.slug } }));
}

const { slug } = Astro.params;
const { data: snippets } = await getCodeSnippetBySlug(slug!);
const snippet = snippets[0];

if (!snippet) return Astro.redirect("/404");
---

<BaseLayout title={snippet.title} description={snippet.description || undefined}>
  <article>
    <header class="mb-8">
      <h1 class="text-3xl font-bold leading-tight sm:text-4xl">{snippet.title}</h1>
      <div class="mt-3 flex items-center gap-3">
        <span class="rounded-md bg-surface px-2.5 py-0.5 font-mono text-xs text-text-muted">
          {snippet.language}
        </span>
      </div>
      {snippet.description && (
        <p class="mt-3 text-text-muted">{snippet.description}</p>
      )}
    </header>

    <div class="overflow-hidden rounded-xl">
      <pre class="overflow-x-auto bg-code-bg p-6 text-sm leading-relaxed text-code-text"><code class={`language-${snippet.language}`}>{snippet.code}</code></pre>
    </div>

    <footer class="mt-12 space-y-6 border-t border-border pt-8">
      {snippet.tags?.length > 0 && <TagList tags={snippet.tags} />}
      {snippet.author && <AuthorCard author={snippet.author} />}
    </footer>
  </article>
</BaseLayout>
